package ua.com.composeimport android.content.Intentimport android.graphics.drawable.Drawableimport android.net.Uriimport android.os.Bundleimport android.os.Parcelableimport android.widget.Toastimport androidx.appcompat.app.AppCompatActivityimport androidx.core.splashscreen.SplashScreen.Companion.installSplashScreenimport androidx.core.view.WindowCompatimport androidx.core.view.isVisibleimport androidx.recyclerview.widget.RecyclerViewimport com.google.android.material.bottomsheet.BottomSheetDialogFragmentimport ua.com.compose.databinding.ActivityMainBindingimport ua.com.compose.extension.*import ua.com.compose.mvp.BaseMvpViewimport ua.com.compose.mvp.data.Menuimport ua.com.compose.fragments.ColorPickFragmentimport ua.com.compose.customView.SpanningLinearLayoutManagerclass MainActivity: AppCompatActivity(), BaseMvpView {    private var binding: ActivityMainBinding? = null    override fun onCreate(savedInstanceState: Bundle?) {        super.onCreate(savedInstanceState)        installSplashScreen()        WindowCompat.setDecorFitsSystemWindows(window, false)        binding = ActivityMainBinding.inflate(layoutInflater).apply {            setContentView(this.root)        }        binding?.root?.setPaddingTop(statusBarHeight())        binding?.bottomMenu?.isEnabled = false        binding?.alert?.setVibrate(EVibrate.BUTTON)        supportFragmentManager.replace(fragment = ColorPickFragment.newInstance(null), containerId = R.id.id_fragment_container, addToBackStack = true)        closeAllDialogs()        if(intent?.action == Intent.ACTION_SEND) {            if (intent.type?.startsWith("image/") == true) {                handleSendImage(intent)            }        }    }    override fun onNewIntent(intent: Intent?) {        super.onNewIntent(intent)        if(intent?.action == Intent.ACTION_SEND) {            if (intent.type?.startsWith("image/") == true) {                handleSendImage(intent)            }        }    }    private fun handleSendImage(intent: Intent) {        (intent.getParcelableExtra<Parcelable>(Intent.EXTRA_STREAM) as? Uri)?.let { uri ->            closeAllDialogs()            supportFragmentManager.clearAllFragments()            supportFragmentManager.replace(fragment = ColorPickFragment.newInstance(uri), containerId = R.id.id_fragment_container, addToBackStack = true)        }    }    private var currentBottomMenu = mutableListOf<Menu>()    override fun setupBottomMenu(menu: MutableList<Menu>) {        binding?.bottomMenuContainer?.setMarginBottom(binding?.bottomMenuContainer?.context?.navigationBarHeight() ?: 0)        currentBottomMenu = menu.filter { it.isVisible.invoke() }.toMutableList()        if(currentBottomMenu.isEmpty()){            binding?.bottomMenu?.isEnabled = false            binding?.bottomMenuContainer?.isVisible = false        }else{            binding?.bottomMenu?.layoutManager = SpanningLinearLayoutManager(this, RecyclerView.HORIZONTAL, false)            binding?.bottomMenu?.adapter = MenuRvAdapter(menu = currentBottomMenu)            if(binding?.bottomMenu?.isEnabled != currentBottomMenu.isNotEmpty()){                binding?.bottomMenu?.isEnabled = true                binding?.bottomMenuContainer?.isVisible = true            }        }    }    private fun closeAllDialogs(){        this.supportFragmentManager.fragments.filterIsInstance<BottomSheetDialogFragment>().forEach {            it.dismissAllowingStateLoss()        }    }    override fun onBackPressed() {        finish()    }    override fun onDestroy() {        super.onDestroy()        binding = null    }}